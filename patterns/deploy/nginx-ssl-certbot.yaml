id: nginx-ssl-certbot
version: "1.0.0"
updated_at: "2026-01-31"
author: "nyko-team"
status: beta

name: "Nginx with SSL via Certbot"
description: "Production Nginx reverse proxy with automatic SSL certificates from Let's Encrypt"

category: deploy
tags:
  - nginx
  - ssl
  - certbot
  - lets-encrypt
  - reverse-proxy
  - production

difficulty: intermediate
time_estimate: "20-30 min"

stack:
  required:
    - name: "nginx"
      version: "^1.24.0"
      reason: "Web server and reverse proxy"
    - name: "certbot"
      version: "^2.0.0"
      reason: "Let's Encrypt certificate automation"

requires: []

enables: []

env_vars:
  required:
    - key: DOMAIN
      description: "Your domain name"
      format: "yourdomain.com"
      where_to_find: "Your domain registrar"
    - key: EMAIL
      description: "Email for Let's Encrypt notifications"
      format: "admin@yourdomain.com"
      where_to_find: "Your email"
    - key: APP_PORT
      description: "Port your application runs on"
      format: "3000"
      where_to_find: "Your application config"

external_setup:
  - service: "Domain DNS"
    url: "Your domain registrar"
    steps:
      - "Point your domain A record to your server IP"
      - "Optional: Add www subdomain CNAME to main domain"
      - "Wait for DNS propagation (can take up to 48h)"

  - service: "Server"
    url: "Your VPS provider"
    steps:
      - "Ensure ports 80 and 443 are open in firewall"
      - "Install Nginx: apt install nginx"
      - "Install Certbot: apt install certbot python3-certbot-nginx"

files:
  - path: "nginx/sites-available/app.conf"
    action: create
    description: "Nginx site configuration"
    priority: 1

  - path: "scripts/setup-ssl.sh"
    action: create
    description: "SSL setup script"
    priority: 2

  - path: "scripts/renew-ssl.sh"
    action: create
    description: "SSL renewal script"
    priority: 3

  - path: "nginx/nginx.conf"
    action: create
    description: "Main Nginx configuration"
    priority: 4

code:
  nginx/sites-available/app.conf: |
    # Redirect HTTP to HTTPS
    server {
        listen 80;
        listen [::]:80;
        server_name ${DOMAIN} www.${DOMAIN};

        # Allow Let's Encrypt verification
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # Redirect all other traffic to HTTPS
        location / {
            return 301 https://$host$request_uri;
        }
    }

    # HTTPS server
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name ${DOMAIN} www.${DOMAIN};

        # SSL certificates (managed by Certbot)
        ssl_certificate /etc/letsencrypt/live/${DOMAIN}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/${DOMAIN}/privkey.pem;

        # SSL configuration
        ssl_session_timeout 1d;
        ssl_session_cache shared:SSL:50m;
        ssl_session_tickets off;

        # Modern SSL configuration
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;

        # HSTS
        add_header Strict-Transport-Security "max-age=63072000" always;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Gzip compression
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

        # Proxy settings
        location / {
            proxy_pass http://localhost:${APP_PORT};
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Static files caching (if serving from Nginx)
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2)$ {
            proxy_pass http://localhost:${APP_PORT};
            proxy_set_header Host $host;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }

        # Health check endpoint
        location /health {
            proxy_pass http://localhost:${APP_PORT}/api/health;
            proxy_set_header Host $host;
        }

        # Error pages
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

  scripts/setup-ssl.sh: |
    #!/bin/bash
    set -e

    # Colors
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m'

    # Check if running as root
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}Please run as root (sudo)${NC}"
        exit 1
    fi

    # Load environment variables
    if [ -f .env ]; then
        export $(cat .env | grep -v '^#' | xargs)
    fi

    # Check required variables
    if [ -z "$DOMAIN" ] || [ -z "$EMAIL" ]; then
        echo -e "${RED}Error: DOMAIN and EMAIL must be set${NC}"
        echo "Set them in .env file or export them before running this script"
        exit 1
    fi

    echo -e "${GREEN}Setting up SSL for $DOMAIN${NC}"

    # Install required packages
    echo -e "${YELLOW}Installing Nginx and Certbot...${NC}"
    apt update
    apt install -y nginx certbot python3-certbot-nginx

    # Create webroot directory for Let's Encrypt
    mkdir -p /var/www/certbot

    # Copy Nginx configuration
    echo -e "${YELLOW}Configuring Nginx...${NC}"
    envsubst '${DOMAIN} ${APP_PORT}' < nginx/sites-available/app.conf > /etc/nginx/sites-available/${DOMAIN}.conf

    # Enable the site
    ln -sf /etc/nginx/sites-available/${DOMAIN}.conf /etc/nginx/sites-enabled/

    # Remove default site if exists
    rm -f /etc/nginx/sites-enabled/default

    # Test Nginx configuration
    nginx -t

    # Reload Nginx
    systemctl reload nginx

    # Get SSL certificate
    echo -e "${YELLOW}Obtaining SSL certificate...${NC}"
    certbot --nginx -d ${DOMAIN} -d www.${DOMAIN} --non-interactive --agree-tos --email ${EMAIL}

    # Set up auto-renewal
    echo -e "${YELLOW}Setting up auto-renewal...${NC}"
    systemctl enable certbot.timer
    systemctl start certbot.timer

    echo -e "${GREEN}SSL setup complete!${NC}"
    echo -e "Your site is now available at https://${DOMAIN}"

  scripts/renew-ssl.sh: |
    #!/bin/bash
    set -e

    # Renew certificates
    certbot renew --quiet

    # Reload Nginx to pick up new certificates
    systemctl reload nginx

    echo "SSL certificates renewed successfully"

  nginx/nginx.conf: |
    user www-data;
    worker_processes auto;
    pid /run/nginx.pid;
    include /etc/nginx/modules-enabled/*.conf;

    events {
        worker_connections 1024;
        multi_accept on;
        use epoll;
    }

    http {
        # Basic settings
        sendfile on;
        tcp_nopush on;
        tcp_nodelay on;
        keepalive_timeout 65;
        types_hash_max_size 2048;
        server_tokens off;

        # MIME types
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        # Logging
        log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                        '$status $body_bytes_sent "$http_referer" '
                        '"$http_user_agent" "$http_x_forwarded_for"';

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log warn;

        # Gzip compression
        gzip on;
        gzip_disable "msie6";
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_buffers 16 8k;
        gzip_http_version 1.1;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        # Rate limiting zones
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        limit_conn_zone $binary_remote_addr zone=conn:10m;

        # Include site configurations
        include /etc/nginx/sites-enabled/*;
    }

edge_cases:
  - id: dns-not-propagated
    symptom: "Certbot fails with 'DNS problem'"
    cause: "DNS records not yet propagated"
    solution: |
      1. Verify DNS with: dig +short yourdomain.com
      2. Wait for propagation (up to 48h)
      3. Use DNS checker tools like whatsmydns.net
      4. Ensure A record points to correct IP

  - id: port-80-blocked
    symptom: "Certbot cannot verify domain"
    cause: "Port 80 blocked by firewall"
    solution: |
      Open port 80:
      - UFW: ufw allow 80/tcp
      - iptables: iptables -A INPUT -p tcp --dport 80 -j ACCEPT
      - Cloud: Check security group/firewall rules

  - id: nginx-syntax-error
    symptom: "nginx -t fails"
    cause: "Invalid configuration syntax"
    solution: |
      1. Check nginx error output
      2. Verify variable substitution worked
      3. Test with: nginx -t -c /etc/nginx/nginx.conf
      4. Check for missing semicolons or braces

  - id: certificate-expired
    symptom: "SSL certificate expired warning"
    cause: "Auto-renewal not working"
    solution: |
      1. Test renewal: certbot renew --dry-run
      2. Check certbot timer: systemctl status certbot.timer
      3. Manual renewal: certbot renew --force-renewal
      4. Check logs: journalctl -u certbot

validation:
  manual_test:
    - "Point domain A record to server IP"
    - "Run: sudo bash scripts/setup-ssl.sh"
    - "Visit https://yourdomain.com"
    - "Verify SSL certificate (padlock icon)"
    - "Test auto-redirect: curl -I http://yourdomain.com"
    - "Test renewal: certbot renew --dry-run"
