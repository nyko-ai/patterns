id: docker-compose-dev
version: "1.0.0"
updated_at: "2026-01-30"
author: "nyko-team"
status: stable

name: "Docker Compose Development Setup"
description: "Docker Compose configuration for local development with PostgreSQL and optional services"

category: deploy
tags:
  - docker
  - docker-compose
  - development
  - postgresql
  - local-dev

difficulty: beginner
time_estimate: "10-15 min"

stack:
  required:
    - name: "docker"
      version: "^24.0.0"
      reason: "Container runtime"
    - name: "docker-compose"
      version: "^2.20.0"
      reason: "Multi-container orchestration"

requires: []

enables: []

env_vars:
  required:
    - key: POSTGRES_USER
      description: "PostgreSQL username"
      format: "alphanumeric string"
      where_to_find: "Define in .env file"
    - key: POSTGRES_PASSWORD
      description: "PostgreSQL password"
      format: "secure string"
      where_to_find: "Define in .env file"
    - key: POSTGRES_DB
      description: "PostgreSQL database name"
      format: "alphanumeric string"
      where_to_find: "Define in .env file"
  optional:
    - key: POSTGRES_PORT
      description: "PostgreSQL port mapping"
      default: "5432"

external_setup:
  - service: "Docker"
    url: "https://docs.docker.com/get-docker/"
    steps:
      - "Install Docker Desktop (Mac/Windows) or Docker Engine (Linux)"
      - "Verify installation: docker --version"
      - "Verify Compose: docker compose version"

files:
  - path: "docker-compose.yml"
    action: create
    description: "Main Docker Compose configuration"
    priority: 1

  - path: ".env.docker"
    action: create
    description: "Docker-specific environment variables"
    priority: 2

  - path: ".dockerignore"
    action: create
    description: "Files to exclude from Docker context"
    priority: 3

  - path: "scripts/docker-dev.sh"
    action: create
    description: "Helper script for common Docker commands"
    priority: 4

code:
  docker-compose.yml: |
    version: "3.8"

    services:
      # PostgreSQL Database
      postgres:
        image: postgres:16-alpine
        container_name: app-postgres
        restart: unless-stopped
        ports:
          - "${POSTGRES_PORT:-5432}:5432"
        environment:
          POSTGRES_USER: ${POSTGRES_USER:-postgres}
          POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
          POSTGRES_DB: ${POSTGRES_DB:-app}
        volumes:
          - postgres_data:/var/lib/postgresql/data
          - ./supabase/migrations:/docker-entrypoint-initdb.d:ro
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
          interval: 10s
          timeout: 5s
          retries: 5

      # Redis (optional - for caching, rate limiting, queues)
      redis:
        image: redis:7-alpine
        container_name: app-redis
        restart: unless-stopped
        ports:
          - "${REDIS_PORT:-6379}:6379"
        volumes:
          - redis_data:/data
        healthcheck:
          test: ["CMD", "redis-cli", "ping"]
          interval: 10s
          timeout: 5s
          retries: 5

      # MinIO (optional - S3-compatible storage)
      minio:
        image: minio/minio
        container_name: app-minio
        restart: unless-stopped
        ports:
          - "${MINIO_PORT:-9000}:9000"
          - "${MINIO_CONSOLE_PORT:-9001}:9001"
        environment:
          MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
          MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
        volumes:
          - minio_data:/data
        command: server /data --console-address ":9001"
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
          interval: 30s
          timeout: 20s
          retries: 3

      # Mailpit (optional - local email testing)
      mailpit:
        image: axllent/mailpit
        container_name: app-mailpit
        restart: unless-stopped
        ports:
          - "${MAILPIT_SMTP_PORT:-1025}:1025"
          - "${MAILPIT_UI_PORT:-8025}:8025"

    volumes:
      postgres_data:
      redis_data:
      minio_data:

    networks:
      default:
        name: app-network

  .env.docker: |
    # PostgreSQL
    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=postgres
    POSTGRES_DB=app
    POSTGRES_PORT=5432

    # Redis
    REDIS_PORT=6379

    # MinIO (S3-compatible storage)
    MINIO_PORT=9000
    MINIO_CONSOLE_PORT=9001
    MINIO_ROOT_USER=minioadmin
    MINIO_ROOT_PASSWORD=minioadmin

    # Mailpit (email testing)
    MAILPIT_SMTP_PORT=1025
    MAILPIT_UI_PORT=8025

    # Connection strings for your app
    DATABASE_URL=postgresql://postgres:postgres@localhost:5432/app
    REDIS_URL=redis://localhost:6379

  .dockerignore: |
    # Dependencies
    node_modules
    .pnpm-store

    # Build outputs
    .next
    out
    build
    dist

    # Environment files (except docker-specific)
    .env
    .env.local
    .env.production

    # Git
    .git
    .gitignore

    # IDE
    .idea
    .vscode

    # OS
    .DS_Store
    Thumbs.db

    # Logs
    *.log
    npm-debug.log*

    # Test
    coverage
    .nyc_output

    # Docker
    Dockerfile*
    docker-compose*.yml
    .docker

  scripts/docker-dev.sh: |
    #!/bin/bash
    set -e

    # Colors for output
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    NC='\033[0m' # No Color

    # Load environment variables
    if [ -f .env.docker ]; then
      export $(cat .env.docker | grep -v '^#' | xargs)
    fi

    case "$1" in
      up)
        echo -e "${GREEN}Starting Docker services...${NC}"
        docker compose up -d
        echo -e "${GREEN}Services started!${NC}"
        echo ""
        echo "PostgreSQL: localhost:${POSTGRES_PORT:-5432}"
        echo "Redis:      localhost:${REDIS_PORT:-6379}"
        echo "MinIO:      localhost:${MINIO_PORT:-9000} (console: ${MINIO_CONSOLE_PORT:-9001})"
        echo "Mailpit:    localhost:${MAILPIT_UI_PORT:-8025}"
        ;;

      down)
        echo -e "${YELLOW}Stopping Docker services...${NC}"
        docker compose down
        echo -e "${GREEN}Services stopped!${NC}"
        ;;

      reset)
        echo -e "${RED}Resetting Docker services (data will be lost)...${NC}"
        docker compose down -v
        docker compose up -d
        echo -e "${GREEN}Services reset!${NC}"
        ;;

      logs)
        docker compose logs -f ${2:-}
        ;;

      ps)
        docker compose ps
        ;;

      db)
        echo -e "${GREEN}Connecting to PostgreSQL...${NC}"
        docker compose exec postgres psql -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-app}
        ;;

      redis-cli)
        echo -e "${GREEN}Connecting to Redis...${NC}"
        docker compose exec redis redis-cli
        ;;

      *)
        echo "Usage: $0 {up|down|reset|logs|ps|db|redis-cli}"
        echo ""
        echo "Commands:"
        echo "  up        Start all services"
        echo "  down      Stop all services"
        echo "  reset     Stop and remove all data, then restart"
        echo "  logs      View logs (optional: service name)"
        echo "  ps        List running services"
        echo "  db        Connect to PostgreSQL"
        echo "  redis-cli Connect to Redis"
        exit 1
        ;;
    esac

edge_cases:
  - id: port-already-in-use
    symptom: "Error: bind: address already in use"
    cause: "Another service is using the same port"
    solution: |
      1. Find what's using the port: lsof -i :5432
      2. Either stop that service, or
      3. Change the port in .env.docker: POSTGRES_PORT=5433
      4. Restart: docker compose down && docker compose up -d

  - id: volume-permission-denied
    symptom: "Permission denied when accessing mounted volumes"
    cause: "Container user doesn't match host user"
    solution: |
      For Linux, add user mapping to the service:
      services:
        postgres:
          user: "${UID:-1000}:${GID:-1000}"

      Or fix permissions: sudo chown -R 1000:1000 ./data

  - id: container-not-starting
    symptom: "Container keeps restarting or won't start"
    cause: "Various - check logs for specific error"
    solution: |
      1. Check logs: docker compose logs postgres
      2. Common fixes:
         - Remove volume and restart: docker compose down -v && docker compose up -d
         - Check disk space: df -h
         - Verify environment variables

  - id: cannot-connect-from-app
    symptom: "App can't connect to database"
    cause: "Wrong connection string or network issues"
    solution: |
      For apps running on host (not in Docker):
      DATABASE_URL=postgresql://postgres:postgres@localhost:5432/app

      For apps running in Docker:
      DATABASE_URL=postgresql://postgres:postgres@postgres:5432/app

      Note the hostname difference (localhost vs service name)

validation:
  manual_test:
    - "Copy .env.docker to your project root"
    - "Run: docker compose up -d"
    - "Check services: docker compose ps"
    - "Connect to PostgreSQL: docker compose exec postgres psql -U postgres"
    - "Run \\l to list databases"
    - "Check Mailpit UI at http://localhost:8025"
    - "Stop services: docker compose down"
