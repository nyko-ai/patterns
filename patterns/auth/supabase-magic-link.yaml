id: supabase-magic-link
version: "1.0.0"
updated_at: "2026-01-30"
author: "nyko-team"
status: stable

name: "Supabase Magic Link Authentication"
description: "Passwordless email magic link authentication with Supabase Auth"

category: auth
tags:
  - supabase
  - magic-link
  - passwordless
  - email
  - nextjs

difficulty: beginner
time_estimate: "15-20 min"

stack:
  required:
    - name: "next"
      version: "^15.1.0"
      reason: "App Router with server components"
    - name: "@supabase/supabase-js"
      version: "^2.49.0"
      reason: "Supabase client library"
    - name: "@supabase/ssr"
      version: "^0.5.2"
      reason: "SSR utilities for cookie-based auth"

requires:
  - supabase-client-nextjs

enables:
  - supabase-protected-routes
  - supabase-signout

env_vars:
  required:
    - key: NEXT_PUBLIC_SUPABASE_URL
      description: "Supabase project URL"
      format: "https://xxx.supabase.co"
      where_to_find: "Supabase Dashboard > Project Settings > API"
    - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
      description: "Supabase anonymous/public key"
      format: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
      where_to_find: "Supabase Dashboard > Project Settings > API"

external_setup:
  - service: "Supabase"
    url: "https://supabase.com/dashboard"
    steps:
      - "Go to Authentication > URL Configuration"
      - "Set Site URL to your production URL"
      - "Add localhost:3000 to Redirect URLs for development"
      - "Optionally customize email templates in Authentication > Email Templates"

files:
  - path: "middleware.ts"
    action: create
    description: "Root middleware for session refresh"
    priority: 1

  - path: "app/auth/callback/route.ts"
    action: create
    description: "Auth callback handler"
    priority: 2

  - path: "app/login/page.tsx"
    action: create
    description: "Login page with magic link form"
    priority: 3

  - path: "components/auth/magic-link-form.tsx"
    action: create
    description: "Magic link email form component"
    priority: 4

  - path: "app/login/check-email/page.tsx"
    action: create
    description: "Check email confirmation page"
    priority: 5

code:
  middleware.ts: |
    import { type NextRequest } from "next/server";
    import { updateSession } from "@/lib/supabase/middleware";

    export async function middleware(request: NextRequest) {
      return (await updateSession(request)).supabaseResponse;
    }

    export const config = {
      matcher: [
        "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
      ],
    };

  app/auth/callback/route.ts: |
    import { createClient } from "@/lib/supabase/server";
    import { NextResponse } from "next/server";

    export async function GET(request: Request) {
      const { searchParams, origin } = new URL(request.url);
      const code = searchParams.get("code");
      const next = searchParams.get("next") ?? "/";

      if (code) {
        const supabase = await createClient();
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (!error) {
          const forwardedHost = request.headers.get("x-forwarded-host");
          const isLocalEnv = process.env.NODE_ENV === "development";
          if (isLocalEnv) {
            return NextResponse.redirect(`${origin}${next}`);
          } else if (forwardedHost) {
            return NextResponse.redirect(`https://${forwardedHost}${next}`);
          } else {
            return NextResponse.redirect(`${origin}${next}`);
          }
        }
      }

      return NextResponse.redirect(`${origin}/auth/auth-code-error`);
    }

  app/login/page.tsx: |
    import { MagicLinkForm } from "@/components/auth/magic-link-form";
    import { createClient } from "@/lib/supabase/server";
    import { redirect } from "next/navigation";

    export default async function LoginPage() {
      const supabase = await createClient();
      const { data: { user } } = await supabase.auth.getUser();

      if (user) {
        redirect("/");
      }

      return (
        <div className="flex min-h-screen items-center justify-center">
          <div className="w-full max-w-sm space-y-6 p-8">
            <div className="text-center">
              <h1 className="text-2xl font-bold">Sign in</h1>
              <p className="text-muted-foreground mt-2">
                Enter your email to receive a magic link
              </p>
            </div>

            <MagicLinkForm />
          </div>
        </div>
      );
    }

  components/auth/magic-link-form.tsx: |
    "use client";

    import { createClient } from "@/lib/supabase/client";
    import { useState } from "react";
    import { useRouter } from "next/navigation";

    export function MagicLinkForm() {
      const [email, setEmail] = useState("");
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const router = useRouter();

      const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setIsLoading(true);
        setError(null);

        const supabase = createClient();

        const { error } = await supabase.auth.signInWithOtp({
          email,
          options: {
            emailRedirectTo: `${window.location.origin}/auth/callback`,
          },
        });

        if (error) {
          setError(error.message);
          setIsLoading(false);
        } else {
          router.push("/login/check-email");
        }
      };

      return (
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label
              htmlFor="email"
              className="block text-sm font-medium text-gray-700"
            >
              Email address
            </label>
            <input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              required
              placeholder="you@example.com"
              className="mt-1 block w-full rounded-lg border border-gray-300 px-4 py-3 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
            />
          </div>

          {error && (
            <div className="rounded-lg bg-red-50 p-3 text-sm text-red-600">
              {error}
            </div>
          )}

          <button
            type="submit"
            disabled={isLoading}
            className="w-full rounded-lg bg-blue-600 px-4 py-3 text-sm font-medium text-white shadow-sm transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
          >
            {isLoading ? "Sending..." : "Send magic link"}
          </button>
        </form>
      );
    }

  app/login/check-email/page.tsx: |
    import Link from "next/link";

    export default function CheckEmailPage() {
      return (
        <div className="flex min-h-screen items-center justify-center">
          <div className="w-full max-w-sm space-y-6 p-8 text-center">
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
              <svg
                className="h-8 w-8 text-green-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                />
              </svg>
            </div>

            <div>
              <h1 className="text-2xl font-bold">Check your email</h1>
              <p className="text-muted-foreground mt-2">
                We sent you a magic link. Click the link in your email to sign in.
              </p>
            </div>

            <p className="text-sm text-gray-500">
              Didn&apos;t receive an email?{" "}
              <Link href="/login" className="text-blue-600 hover:underline">
                Try again
              </Link>
            </p>
          </div>
        </div>
      );
    }

edge_cases:
  - id: email-not-received
    symptom: "User doesn't receive magic link email"
    cause: "Email in spam, Supabase email limits, or SMTP issues"
    solution: |
      1. Check spam/junk folder
      2. Verify email is correct
      3. Check Supabase Dashboard > Authentication > Logs for send status
      4. Supabase free tier has email rate limits (4 emails/hour)
      5. For production, configure custom SMTP in Supabase settings

  - id: link-expired
    symptom: "Magic link shows 'Link expired' error"
    cause: "Magic links expire after 24 hours by default"
    solution: |
      1. Request a new magic link
      2. Click the link within 24 hours
      3. To customize expiry, go to Supabase Dashboard > Authentication > Settings

  - id: already-used-link
    symptom: "Error when clicking magic link a second time"
    cause: "Magic links are single-use for security"
    solution: |
      This is expected behavior. Each magic link can only be used once.
      Request a new link if needed.

  - id: wrong-redirect
    symptom: "Redirected to wrong URL after clicking magic link"
    cause: "emailRedirectTo not matching allowed URLs"
    solution: |
      1. Go to Supabase Dashboard > Authentication > URL Configuration
      2. Add your URL to "Redirect URLs"
      3. For development: http://localhost:3000/auth/callback
      4. For production: https://yourdomain.com/auth/callback

validation:
  manual_test:
    - "Navigate to /login"
    - "Enter a valid email address"
    - "Click 'Send magic link'"
    - "Verify redirect to /login/check-email"
    - "Check email inbox for magic link"
    - "Click magic link in email"
    - "Verify redirect to home page and user is authenticated"
