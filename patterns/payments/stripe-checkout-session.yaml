id: stripe-checkout-session
version: "1.0.0"
updated_at: "2026-01-30"
author: "nyko-team"
status: stable

name: "Stripe Checkout Session"
description: "Create Stripe Checkout Sessions for one-time payments and subscriptions"

category: payments
tags:
  - stripe
  - checkout
  - payments
  - subscriptions
  - nextjs

difficulty: intermediate
time_estimate: "20-30 min"

stack:
  required:
    - name: "next"
      version: "^15.1.0"
      reason: "App Router with route handlers"
    - name: "stripe"
      version: "^17.4.0"
      reason: "Stripe Node.js SDK"

requires: []

enables:
  - stripe-webhook-handler
  - stripe-customer-portal

env_vars:
  required:
    - key: STRIPE_SECRET_KEY
      description: "Stripe secret API key"
      format: "sk_test_... or sk_live_..."
      where_to_find: "Stripe Dashboard > Developers > API keys"
    - key: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
      description: "Stripe publishable key for client-side"
      format: "pk_test_... or pk_live_..."
      where_to_find: "Stripe Dashboard > Developers > API keys"
  optional:
    - key: STRIPE_WEBHOOK_SECRET
      description: "Webhook signing secret (needed for webhook handler)"
      default: "whsec_..."

external_setup:
  - service: "Stripe"
    url: "https://dashboard.stripe.com"
    steps:
      - "Create a Stripe account or log in"
      - "Go to Developers > API keys"
      - "Copy the Secret key and Publishable key"
      - "Create products in Products > Add product"
      - "Copy the Price ID (price_xxx) for your products"

files:
  - path: "lib/stripe.ts"
    action: create
    description: "Stripe client configuration"
    priority: 1

  - path: "app/api/checkout/route.ts"
    action: create
    description: "Checkout session creation endpoint"
    priority: 2

  - path: "components/checkout-button.tsx"
    action: create
    description: "Client-side checkout button component"
    priority: 3

  - path: "app/checkout/success/page.tsx"
    action: create
    description: "Checkout success page"
    priority: 4

  - path: "app/checkout/cancel/page.tsx"
    action: create
    description: "Checkout cancel page"
    priority: 5

code:
  lib/stripe.ts: |
    import Stripe from "stripe";

    if (!process.env.STRIPE_SECRET_KEY) {
      throw new Error("Missing STRIPE_SECRET_KEY environment variable");
    }

    export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
      apiVersion: "2024-12-18.acacia",
      typescript: true,
    });

  app/api/checkout/route.ts: |
    import { stripe } from "@/lib/stripe";
    import { NextRequest, NextResponse } from "next/server";

    export async function POST(request: NextRequest) {
      try {
        const body = await request.json();
        const { priceId, mode = "payment", customerId, metadata } = body;

        if (!priceId) {
          return NextResponse.json(
            { error: "Price ID is required" },
            { status: 400 }
          );
        }

        // Validate mode
        if (!["payment", "subscription"].includes(mode)) {
          return NextResponse.json(
            { error: "Invalid mode. Must be 'payment' or 'subscription'" },
            { status: 400 }
          );
        }

        const origin = request.headers.get("origin") || "http://localhost:3000";

        const sessionConfig: Stripe.Checkout.SessionCreateParams = {
          mode: mode as "payment" | "subscription",
          line_items: [
            {
              price: priceId,
              quantity: 1,
            },
          ],
          success_url: `${origin}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
          cancel_url: `${origin}/checkout/cancel`,
          metadata: metadata || {},
        };

        // Add customer if provided
        if (customerId) {
          sessionConfig.customer = customerId;
        } else {
          // Allow guest checkout with email collection
          sessionConfig.customer_creation = "always";
        }

        // For subscriptions, enable customer portal
        if (mode === "subscription") {
          sessionConfig.billing_address_collection = "required";
          sessionConfig.payment_method_types = ["card"];
        }

        const session = await stripe.checkout.sessions.create(sessionConfig);

        return NextResponse.json({ url: session.url, sessionId: session.id });
      } catch (error) {
        console.error("Error creating checkout session:", error);

        if (error instanceof Stripe.errors.StripeError) {
          return NextResponse.json(
            { error: error.message },
            { status: error.statusCode || 500 }
          );
        }

        return NextResponse.json(
          { error: "Internal server error" },
          { status: 500 }
        );
      }
    }

  components/checkout-button.tsx: |
    "use client";

    import { useState } from "react";

    interface CheckoutButtonProps {
      priceId: string;
      mode?: "payment" | "subscription";
      customerId?: string;
      metadata?: Record<string, string>;
      children?: React.ReactNode;
      className?: string;
    }

    export function CheckoutButton({
      priceId,
      mode = "payment",
      customerId,
      metadata,
      children = "Buy Now",
      className,
    }: CheckoutButtonProps) {
      const [isLoading, setIsLoading] = useState(false);

      const handleCheckout = async () => {
        setIsLoading(true);

        try {
          const response = await fetch("/api/checkout", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              priceId,
              mode,
              customerId,
              metadata,
            }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to create checkout session");
          }

          // Redirect to Stripe Checkout
          if (data.url) {
            window.location.href = data.url;
          }
        } catch (error) {
          console.error("Checkout error:", error);
          alert("Failed to start checkout. Please try again.");
          setIsLoading(false);
        }
      };

      return (
        <button
          onClick={handleCheckout}
          disabled={isLoading}
          className={
            className ||
            "rounded-lg bg-blue-600 px-6 py-3 text-sm font-medium text-white shadow-sm transition-colors hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
          }
        >
          {isLoading ? "Loading..." : children}
        </button>
      );
    }

  app/checkout/success/page.tsx: |
    import { stripe } from "@/lib/stripe";
    import Link from "next/link";

    interface SuccessPageProps {
      searchParams: Promise<{ session_id?: string }>;
    }

    export default async function CheckoutSuccessPage({
      searchParams,
    }: SuccessPageProps) {
      const { session_id } = await searchParams;

      if (!session_id) {
        return (
          <div className="flex min-h-screen items-center justify-center">
            <div className="text-center">
              <h1 className="text-2xl font-bold">Invalid session</h1>
              <Link href="/" className="mt-4 text-blue-600 hover:underline">
                Return home
              </Link>
            </div>
          </div>
        );
      }

      // Retrieve session details
      const session = await stripe.checkout.sessions.retrieve(session_id, {
        expand: ["line_items", "customer"],
      });

      return (
        <div className="flex min-h-screen items-center justify-center">
          <div className="w-full max-w-md space-y-6 p-8 text-center">
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-green-100">
              <svg
                className="h-8 w-8 text-green-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M5 13l4 4L19 7"
                />
              </svg>
            </div>

            <div>
              <h1 className="text-2xl font-bold">Payment successful!</h1>
              <p className="text-muted-foreground mt-2">
                Thank you for your purchase. A confirmation email has been sent
                to {session.customer_details?.email}.
              </p>
            </div>

            <div className="rounded-lg bg-gray-50 p-4 text-left text-sm">
              <p className="font-medium">Order details</p>
              <p className="mt-2 text-gray-600">
                Amount: {((session.amount_total || 0) / 100).toFixed(2)}{" "}
                {session.currency?.toUpperCase()}
              </p>
              <p className="text-gray-600">
                Status: {session.payment_status}
              </p>
            </div>

            <Link
              href="/"
              className="inline-block rounded-lg bg-blue-600 px-6 py-3 text-sm font-medium text-white hover:bg-blue-700"
            >
              Return home
            </Link>
          </div>
        </div>
      );
    }

  app/checkout/cancel/page.tsx: |
    import Link from "next/link";

    export default function CheckoutCancelPage() {
      return (
        <div className="flex min-h-screen items-center justify-center">
          <div className="w-full max-w-md space-y-6 p-8 text-center">
            <div className="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-gray-100">
              <svg
                className="h-8 w-8 text-gray-600"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  strokeLinecap="round"
                  strokeLinejoin="round"
                  strokeWidth={2}
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </div>

            <div>
              <h1 className="text-2xl font-bold">Checkout cancelled</h1>
              <p className="text-muted-foreground mt-2">
                Your payment was cancelled. No charges have been made.
              </p>
            </div>

            <div className="flex flex-col gap-3">
              <Link
                href="/"
                className="inline-block rounded-lg bg-blue-600 px-6 py-3 text-sm font-medium text-white hover:bg-blue-700"
              >
                Return home
              </Link>
              <Link
                href="/pricing"
                className="text-sm text-blue-600 hover:underline"
              >
                View pricing again
              </Link>
            </div>
          </div>
        </div>
      );
    }

edge_cases:
  - id: invalid-price-id
    symptom: "Error: No such price: 'price_xxx'"
    cause: "Price ID doesn't exist or is from different Stripe mode (test vs live)"
    solution: |
      1. Go to Stripe Dashboard > Products
      2. Find your product and copy the correct Price ID
      3. Make sure you're using test prices with test keys
      4. Price IDs start with "price_"

  - id: card-declined
    symptom: "Checkout fails with card declined error"
    cause: "Card was rejected by the bank or Stripe"
    solution: |
      This is normal behavior. Stripe handles the error display.
      For testing, use these test cards:
      - Success: 4242 4242 4242 4242
      - Decline: 4000 0000 0000 0002
      - Requires auth: 4000 0025 0000 3155

  - id: customer-not-found
    symptom: "Error: No such customer: 'cus_xxx'"
    cause: "Customer ID is invalid or from different Stripe mode"
    solution: |
      1. Verify the customer exists in Stripe Dashboard
      2. Check if using test vs live mode correctly
      3. Create a new customer if needed
      4. Or remove customerId to allow guest checkout

  - id: webhook-not-receiving
    symptom: "Payment successful but database not updated"
    cause: "Webhooks not configured or failing"
    solution: |
      See the stripe-webhook-handler pattern for proper webhook setup.
      Always use webhooks to confirm payments - don't rely solely on
      success page redirects.

validation:
  manual_test:
    - "Create a product and price in Stripe Dashboard (test mode)"
    - "Add the CheckoutButton with the price ID"
    - "Click the button to start checkout"
    - "Use test card 4242 4242 4242 4242"
    - "Complete checkout and verify redirect to success page"
    - "Check Stripe Dashboard > Payments for the transaction"
