id: docker-production
version: "1.0.0"
updated_at: "2026-01-31"
author: "nyko-team"
status: beta

name: "Production Docker Setup"
description: "Multi-stage Dockerfile for Next.js production deployment"

category: devops
tags:
  - docker
  - production
  - nextjs
  - deployment
  - containers

difficulty: intermediate
time_estimate: "15-25 min"

stack:
  required:
    - name: "next"
      version: "^15.1.0"
      reason: "Next.js App Router"

requires: []

enables: []

env_vars:
  required: []
  optional:
    - key: NODE_ENV
      description: "Node environment"
      default: "production"
    - key: PORT
      description: "Application port"
      default: "3000"
    - key: HOSTNAME
      description: "Server hostname"
      default: "0.0.0.0"

external_setup:
  - service: "Docker"
    url: "https://docs.docker.com/get-docker/"
    steps:
      - "Install Docker Desktop or Docker Engine"
      - "Enable BuildKit for faster builds"
      - "Configure Docker Hub or private registry (optional)"

files:
  - path: "Dockerfile"
    action: create
    description: "Multi-stage production Dockerfile"
    priority: 1

  - path: ".dockerignore"
    action: create
    description: "Docker ignore file"
    priority: 2

  - path: "docker-compose.yml"
    action: create
    description: "Docker Compose for development"
    priority: 3

  - path: "docker-compose.prod.yml"
    action: create
    description: "Docker Compose for production"
    priority: 4

  - path: "next.config.ts"
    action: modify
    description: "Enable standalone output"
    priority: 5

code:
  Dockerfile: |
    # syntax=docker/dockerfile:1

    # ========================================
    # Base stage - common dependencies
    # ========================================
    FROM node:20-alpine AS base

    # Install dependencies needed for node-gyp and sharp
    RUN apk add --no-cache libc6-compat

    # Enable corepack for pnpm
    RUN corepack enable && corepack prepare pnpm@latest --activate

    # Set working directory
    WORKDIR /app

    # ========================================
    # Dependencies stage - install deps
    # ========================================
    FROM base AS deps

    # Copy package files
    COPY package.json pnpm-lock.yaml* ./

    # Install dependencies
    RUN --mount=type=cache,target=/root/.local/share/pnpm/store \
        pnpm install --frozen-lockfile

    # ========================================
    # Builder stage - build the application
    # ========================================
    FROM base AS builder

    WORKDIR /app

    # Copy dependencies from deps stage
    COPY --from=deps /app/node_modules ./node_modules
    COPY . .

    # Set build-time environment variables
    ARG NEXT_PUBLIC_APP_URL
    ENV NEXT_PUBLIC_APP_URL=$NEXT_PUBLIC_APP_URL

    # Disable Next.js telemetry during build
    ENV NEXT_TELEMETRY_DISABLED=1

    # Build the application
    RUN pnpm build

    # ========================================
    # Runner stage - production image
    # ========================================
    FROM node:20-alpine AS runner

    WORKDIR /app

    # Set production environment
    ENV NODE_ENV=production
    ENV NEXT_TELEMETRY_DISABLED=1

    # Create non-root user for security
    RUN addgroup --system --gid 1001 nodejs
    RUN adduser --system --uid 1001 nextjs

    # Copy public assets
    COPY --from=builder /app/public ./public

    # Set correct permissions for prerender cache
    RUN mkdir .next
    RUN chown nextjs:nodejs .next

    # Copy standalone build output
    COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
    COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

    # Switch to non-root user
    USER nextjs

    # Expose port
    EXPOSE 3000

    # Set hostname to listen on all interfaces
    ENV PORT=3000
    ENV HOSTNAME="0.0.0.0"

    # Health check
    HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
      CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1

    # Start the application
    CMD ["node", "server.js"]

  .dockerignore: |
    # Dependencies
    node_modules
    .pnpm-store

    # Build outputs
    .next
    out
    build
    dist

    # Development files
    .git
    .gitignore
    .env*.local
    .env.development
    .env.test

    # IDE and editor files
    .vscode
    .idea
    *.swp
    *.swo

    # Test files
    __tests__
    *.test.ts
    *.test.tsx
    *.spec.ts
    *.spec.tsx
    coverage
    playwright-report
    test-results
    e2e

    # Documentation
    README.md
    CHANGELOG.md
    docs

    # Docker files (prevent recursive copy)
    Dockerfile*
    docker-compose*.yml
    .dockerignore

    # Misc
    .DS_Store
    *.log
    npm-debug.log*
    pnpm-debug.log*

  docker-compose.yml: |
    version: "3.9"

    services:
      app:
        build:
          context: .
          dockerfile: Dockerfile
          target: deps
        command: pnpm dev
        volumes:
          - .:/app
          - /app/node_modules
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=development
          - NEXT_TELEMETRY_DISABLED=1
        env_file:
          - .env.local
        depends_on:
          - db
          - redis

      db:
        image: postgres:16-alpine
        volumes:
          - postgres_data:/var/lib/postgresql/data
        environment:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: app_development
        ports:
          - "5432:5432"
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U postgres"]
          interval: 10s
          timeout: 5s
          retries: 5

      redis:
        image: redis:7-alpine
        volumes:
          - redis_data:/data
        ports:
          - "6379:6379"
        healthcheck:
          test: ["CMD", "redis-cli", "ping"]
          interval: 10s
          timeout: 5s
          retries: 5

    volumes:
      postgres_data:
      redis_data:

  docker-compose.prod.yml: |
    version: "3.9"

    services:
      app:
        build:
          context: .
          dockerfile: Dockerfile
          args:
            - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
        restart: unless-stopped
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=production
          - DATABASE_URL=${DATABASE_URL}
          - REDIS_URL=${REDIS_URL}
        env_file:
          - .env.production
        depends_on:
          db:
            condition: service_healthy
          redis:
            condition: service_healthy
        healthcheck:
          test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
          interval: 30s
          timeout: 10s
          retries: 3
          start_period: 40s
        deploy:
          resources:
            limits:
              cpus: "1"
              memory: 512M
            reservations:
              cpus: "0.25"
              memory: 256M

      db:
        image: postgres:16-alpine
        restart: unless-stopped
        volumes:
          - postgres_data:/var/lib/postgresql/data
          - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro
        environment:
          POSTGRES_USER: ${POSTGRES_USER}
          POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
          POSTGRES_DB: ${POSTGRES_DB}
        healthcheck:
          test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
          interval: 10s
          timeout: 5s
          retries: 5
        deploy:
          resources:
            limits:
              cpus: "0.5"
              memory: 256M

      redis:
        image: redis:7-alpine
        restart: unless-stopped
        command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
        volumes:
          - redis_data:/data
        healthcheck:
          test: ["CMD", "redis-cli", "ping"]
          interval: 10s
          timeout: 5s
          retries: 5
        deploy:
          resources:
            limits:
              cpus: "0.25"
              memory: 128M

      # Optional: Nginx reverse proxy
      nginx:
        image: nginx:alpine
        restart: unless-stopped
        ports:
          - "80:80"
          - "443:443"
        volumes:
          - ./nginx.conf:/etc/nginx/nginx.conf:ro
          - ./certs:/etc/nginx/certs:ro
        depends_on:
          - app
        profiles:
          - with-nginx

    volumes:
      postgres_data:
      redis_data:

    networks:
      default:
        driver: bridge

  next.config.ts: |
    // Add to next.config.ts for standalone output
    import type { NextConfig } from "next";

    const nextConfig: NextConfig = {
      // Enable standalone output for Docker
      output: "standalone",

      // Disable x-powered-by header
      poweredByHeader: false,

      // Enable strict mode
      reactStrictMode: true,

      // Image optimization
      images: {
        remotePatterns: [
          {
            protocol: "https",
            hostname: "**",
          },
        ],
        // Use sharp for image optimization in Docker
        unoptimized: process.env.NODE_ENV === "development",
      },

      // Experimental features
      experimental: {
        // Enable server actions
        serverActions: {
          bodySizeLimit: "2mb",
        },
      },

      // Headers
      async headers() {
        return [
          {
            source: "/:path*",
            headers: [
              {
                key: "X-DNS-Prefetch-Control",
                value: "on",
              },
              {
                key: "X-Frame-Options",
                value: "SAMEORIGIN",
              },
              {
                key: "X-Content-Type-Options",
                value: "nosniff",
              },
              {
                key: "Referrer-Policy",
                value: "origin-when-cross-origin",
              },
            ],
          },
        ];
      },
    };

    export default nextConfig;

edge_cases:
  - id: build-cache-issues
    symptom: "Build takes too long or fails"
    cause: "Docker cache not being used"
    solution: "Use BuildKit and --mount=type=cache for pnpm store"

  - id: node-modules-volume
    symptom: "Dependencies not found in development"
    cause: "node_modules mounted from host"
    solution: "Use anonymous volume for node_modules"

  - id: env-vars-not-loaded
    symptom: "Environment variables undefined"
    cause: "Build-time vs runtime env confusion"
    solution: "Use ARG for build-time, ENV for runtime variables"

  - id: sharp-error
    symptom: "Sharp module not found"
    cause: "Native dependencies not installed"
    solution: "Use libc6-compat in Alpine image"

  - id: permission-denied
    symptom: "Cannot write to .next folder"
    cause: "Running as non-root user"
    solution: "Create .next folder and set ownership before switching user"

validation:
  manual_test:
    - "Run docker build -t app ."
    - "Verify build completes successfully"
    - "Run docker run -p 3000:3000 app"
    - "Access localhost:3000"
    - "Check docker-compose up works"
    - "Verify health check passes"
